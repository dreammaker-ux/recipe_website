{% extends "base.html" %}
{% block title %}烹饪模式 - {{ recipe.title }}{% endblock %}
{% block content %}
<style>
    .cook-bg {
        /* 渐变背景+美食主题图片+半透明遮罩 */
        min-height: 100vh;
        background:
            linear-gradient(120deg, #f8fafc 0%, #e0f7fa 100%),
            url("{{ url_for('static', filename='img/cook_bg.jpg') }}") center/cover no-repeat;
        position: relative;
    }
    .cook-bg::before {
        content: "";
        position: absolute;
        left: 0; top: 0; right: 0; bottom: 0;
        background: rgba(255,255,255,0.7);
        z-index: 0;
    }
    .container.cook-container {
        position: relative;
        z-index: 1;
    }
    .cook-step {
        font-size: 1.5em;
        margin: 2em 0;
        padding: 2em;
        background: rgba(255,255,255,0.95);
        border-radius: 1em;
        box-shadow: 0 2px 16px rgba(0,0,0,0.07);
    }
    .cook-controls {
        margin: 2em 0;
    }
    .cook-ingredients {
        font-size: 1.2em;
        background: rgba(227,242,253,0.95);
        border-radius: 0.5em;
        padding: 1em;
        margin-bottom: 2em;
        box-shadow: 0 1px 8px rgba(0,0,0,0.04);
    }
</style>
<div class="cook-bg py-5">
    <div class="container cook-container text-center">
        <h1 class="mb-4">{{ recipe.title }}</h1>
        {% if recipe.image_url %}
        <img src="{{ recipe.image_url }}" alt="{{ recipe.title }}" class="mb-4 rounded shadow" style="max-width: 350px; max-height: 250px; object-fit: cover;">
        {% endif %}
        <div class="cook-ingredients mb-4">
            <strong>食材：</strong><br>
            {{ recipe.ingredients|replace('\n', '<br>')|safe }}
        </div>
        <div id="step-area" class="cook-step"></div>
        <div class="cook-timer mb-4">
            <div id="timer-display" style="font-size:2em;font-weight:bold;">00:00</div>
            <div class="mt-2">
                <button id="timer-start" class="btn btn-outline-success btn-sm me-2">开始</button>
                <button id="timer-pause" class="btn btn-outline-warning btn-sm me-2" disabled>暂停</button>
                <button id="timer-reset" class="btn btn-outline-secondary btn-sm">重置</button>
            </div>
        </div>

        <div class="cook-controls">
            <button id="prev-step" class="btn btn-primary btn-lg">上一步</button>
            <button id="next-step" class="btn btn-primary btn-lg">下一步</button>
        </div>
        <div class="mt-4">
            <form method="POST" enctype="multipart/form-data" class="mb-3">
                <label for="audio_file" class="form-label">导入本地音乐：</label>
                <input type="file" name="audio_file" id="audio_file" accept=".mp3,.wav,.ogg" class="form-control d-inline-block" style="width:auto;display:inline-block;">
                <button type="submit" class="btn btn-success btn-sm ms-2">上传并播放</button>
            </form>
            <audio id="bg-music" controls loop>
                <source src="{{ music_url }}" type="audio/mpeg">
                您的浏览器不支持音频播放。
            </audio>
        </div>
    </div>
</div>
<script>
    let timer = 0;
    let timerInterval = null;
    let running = false;

    function updateTimerDisplay() {
        const min = String(Math.floor(timer / 60)).padStart(2, '0');
        const sec = String(timer % 60).padStart(2, '0');
        document.getElementById('timer-display').textContent = `${min}:${sec}`;
    }

    document.getElementById('timer-start').onclick = function () {
        if (!running) {
            running = true;
            document.getElementById('timer-start').disabled = true;
            document.getElementById('timer-pause').disabled = false;
            timerInterval = setInterval(() => {
                timer++;
                updateTimerDisplay();
            }, 1000);
        }
    };

    document.getElementById('timer-pause').onclick = function () {
        if (running) {
            running = false;
            document.getElementById('timer-start').disabled = false;
            document.getElementById('timer-pause').disabled = true;
            clearInterval(timerInterval);
        }
    };

    document.getElementById('timer-reset').onclick = function () {
        running = false;
        clearInterval(timerInterval);
        timer = 0;
        updateTimerDisplay();
        document.getElementById('timer-start').disabled = false;
        document.getElementById('timer-pause').disabled = true;
    };

    updateTimerDisplay();

const steps = `{{ recipe.instructions|replace('\r\n', '\n')|replace('\r', '\n')|replace('\n\n', '\n')|replace('\n', '|||') }}`.split('|||');
let current = 0;
function showStep(idx) {
    document.getElementById('step-area').innerHTML = `<strong>步骤 ${idx+1}：</strong><br>` + steps[idx];
}
document.getElementById('prev-step').onclick = function() {
    if (current > 0) { current--; showStep(current); }
};
document.getElementById('next-step').onclick = function() {
    if (current < steps.length-1) { current++; showStep(current); }
};
showStep(current);
</script>
{% if current_user.is_authenticated %}
<div class="mt-5">
    <h4>完成烹饪？来打卡并分享你的体验吧！</h4>
    <form method="POST" enctype="multipart/form-data" class="mt-3">
        {{ form.hidden_tag() }}
        <div class="mb-3">
            {{ form.rating.label(class="form-label") }}
            {{ form.rating(class="form-select") }}
        </div>
        <div class="mb-3">
            {{ form.content.label(class="form-label") }}
            {{ form.content(class="form-control", rows=3) }}
        </div>
        <div class="mb-3">
            {{ form.image.label(class="form-label") }}
            {{ form.image(class="form-control") }}
        </div>
        {{ form.submit(class="btn btn-success") }}
    </form>
</div>
{% endif %}

{% endblock %}
